# 海流による熱輸送の推定
OHCの時空間変化を引き起こす要因である、海流による熱輸送を推定しよう。ここでは、海流として地衡流とエクマン流（鉛直積分した輸送）を考える。

## MOAA GPVデータを用いた地衡流の推算  
地衡流の推算のためには、はじめに力学高度（ $D$ ）  
 $D=\int_p^{p_r} \delta dp^\prime = \int_p^{p_r} \rho^{-1} dp^\prime$  
を計算する。ここで $\delta =1/\rho$ は比容（単位質量あたりの体積）、 $p$ は力学高度を求める圧力、 $p_r$ は基準圧力である。実際の計算では、基準とする海水の比容 $\delta_0$ からの偏差を用いて力学行動偏差を計算することで、計算精度を保つようにする。

地衡流は力学高度を用いて  
 $u(p)=u(p_r)-f^{-1}\partial D/\partial y$  
 $v(p)=v(p_r)+f^{-1}\partial D/\partial x$  
と計算される。

力学高度を絶対塩分と保存温度から求める関数と、力学高度から地衡流を推算する関数も、[The Gibbs SeaWater (GSW) Oceanographic Toolbox of TEOS-10](https://www.teos-10.org/pubs/gsw/html/gsw_front_page.html) で提供されている。  
使用する関数は

+ gsw.geo_strf_dyn_height：絶対塩分、保存温度、圧力から力学高度偏差を計算
+ gsw.geostrophic_velocity：力学高度偏差、緯度、経度から地衡流速を計算

の２つ。各関数の使い方は[GSW Toolbox のマニュアル](https://www.teos-10.org/pubs/gsw/html/gsw_contents.html)を参照のこと。

MOAA GPV データを読み込んで地衡流を推算する Python コードのサンプルは[ここ](https://github.com/kugi-yosikawa/DD2025/blob/main/moaa_geovel_sample.pdf)。

注意とTips
+ 上記の関数の引数は最大で２次元の配列とすることができる。３次元は受け付けない。経度・緯度・深度の３次元配列をまとめて引数として関数に渡す場合、経度・緯度をまとめて２次元化すると良い。ndarray の reshape メソッドを使うと便利（サンプルコード：78、79行目）。
+ 引数が２次元配列に場合、gswの関数に渡す配列の最初の次元を深度方向とする必要がある（gsw関数の仕様）。例えば保存温度（ $\Theta$ ）が水平地点（0:im）・深度（0:km）で与えられる場合、 $\Theta$[0:km,0:im] として渡す。元々の関数が $\Theta$[0:im,0:km] なら転置して（.T をつける）渡す必要がある（サンプルコード：78、79行目）。
+ 力学高度の基準圧力は、最初は海面（0db）として計算し、地衡流もその力学高度から（すなわち無流面を海面として）計算すると良い（サンプルコードの74行目）。地衡流を全ての地点で計算したのち、各緯度経度において、計測最深層での流速を差し引くことで、基準圧力面を最深層とすることができる（サンプルコード：107、120行目）。
+ 地衡流は２つの水温・塩分観測地点の間で計算される。そのため、南北方向の地衡流の定義点と東西方向の地衡流の定義点は異なることに注意。南北に jm 個の観測点がある場合、東西地衡流は jm-1 個の地点で定義される。東西の観測点と南北地衡流の定義点についても同様であるが、東西には周期的であるため、南極海など東西に周回している海域では、im 個の観測点から im 個の南北地衡流が定義される。このため用意する配列の数が東西地衡流と南北地衡流で異なる（サンプルコード：71、72、73行目）。
+ 地衡流のマスク配列（欠測なら０、そうでないなら１とする配列）も用意しておくと便利。２地点の力学高度の差から計算されるため、２地点のうちどちらかでも欠測であれば、地衡流も欠測となることに注意（サンプルコード：49、50行目）。


## ERA5の再解析データを用いたエクマン輸送の計算
地衡流に加えてエクマン流も熱輸送に貢献する。エクマン流は海面風応力と粘性係数から計算する。海面風応力は人工衛星の観測値やそれを取り込んだ気象の再解析値を用いる。粘性係数は渦粘性係数であり、海洋表層での乱流状態によって決まる。これを精度良く推定することは（現状では）できないので、各深度でのエクマン流を推定することは諦めて、（渦粘性係数に依存しない、エクマン流を鉛直に積分した）エクマン輸送（ $T_x$ 、 $T_y$ [m $^2$ /s]）を考える。風応力（ $\tau_x$ 、 $\tau_y$ ）との関係は  
 $T_x=\tau_y/(\rho f), T_y=-\tau_x/(\rho f)$
で与えられる。

以下では用いるデータセットについて説明するが、それぞれのデータセットはすでにダウンロードしてあるので、改めてダウンロードする必要はない。

### 人工衛星観測値
人工衛星観測に基づく風応力データセットにはいくつかある。以下では日本が開発・提供する[J-OFURO3](https://www.j-ofuro.com/)の場合を説明する。このデータは複数の人工衛星データをブレンドして作成しているため、精度がたかくなっている。ただし2022年までのデータしか提供されていないことに注意。データのさらなる詳細については[J-OFURO3](https://www.j-ofuro.com/)を参照のこと。

データは[J-OFURO3のサイト](https://www.j-ofuro.com)からダウンロード可能である。月毎・日毎のデータがあるが、この演習では月毎データを用いれば良い。風応力は高解像度（HR：緯度経度0.25度格子）のTAUX、TAUYを選択する。データ形式は MOAA GPV と同様に netcdf 形式である。

注意とTips
+ 0.25度の風応力データをそのまま用いても良いし、MOAA GPV のデータに合わせて１度毎に直して用いても良い。

### 再解析値
Trenberth et al. (2025) でも用いられていた、ECMWF（欧州中期予報局） の ERA5 再解析データについて説明する。2025年の最新のデータも活用できるという利点がある。ERA5はECMWFが開発した第5世代の大気再解析データセットであり、様々な気象要素を公開している。データセットの詳細は[ここ](https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels-monthly-means?tab=overview) を参照のこと。本演習で用いる月平均海面風応力は、[ダウンロードサイト](https://cds.climate.copernicus.eu/datasets/reanalysis-era5-single-levels-monthly-means?tab=download)の Mean rates / Mean eastward turbulent surface stress, Mean northward turbulent surface stress である。対象領域（全球）、対象期間を指定して、netcdf 形式でダウンロードすればよい。



